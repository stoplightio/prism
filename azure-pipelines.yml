jobs:
  - job: test
    displayName: Test
    pool:
      vmImage: vs2017-win2016
    steps:
      - task: NodeTool@0
        inputs:
          versionSpec: '12.x'
        displayName: 'Install Node.js'
      - powershell: | # Not that cool, but it does the job.
         $ver = $env:BUILD_SOURCEBRANCH.remove(0, 10)
         Write-Host "##vso[task.setvariable variable=Tag;isOutput=true]$ver"
        displayName: 'Update version to Tag'
        condition: and(succeeded(), startsWith(variables['Build.SourceBranch'], 'refs/tags/'))

      - script: yarn
        displayName: 'Install deps'

      - script: npx jest
        displayName: 'Run tests'

      - script: yarn build
        displayName: 'Build the code'

      - script: npx pkg --output ./cli-binaries/prism-cli ./packages/cli/
        displayName: 'Create binary'

      - script: yarn test.harness
        displayName: 'Run harness'

      - script: cp ./cli-binaries/prism-cli $(Build.ArtifactStagingDirectory)
        displayName: 'Copy binary in the special Azure directory'

      - publish: $(Build.ArtifactStagingDirectory)
        artifact: $(imageName)
  - job: publish
    dependsOn: test
    displayName: Publish binary
    condition: not(eq(variables['Tag'], 'null'))
    pool:
      vmImage: vs2017-win2016

    steps:
      - script: etucapio